---
title: "Analysis4ABCDE_PNICO_importance_feature.Rmd"
author: "Xiaochun Han"
date: "2025-12-17"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,warning = FALSE, message = FALSE)
rm(list = ls())
source("../utils/functions_library.R")
load_packages(c("dplyr", "ggplot2", "tidyr","purrr"))
```

## Feature importance read
```{r read_feat_impor}
# 读取数据
fi_fs_invest <- readRDS("fi_all_invest_WNS_BNS_5000.RData")
acc_ins_bins <- 0.9212

# 预分配结果向量（确保是数值型）
dec_acc <- numeric(length = 112)
ste_acc <- numeric(length = 112)
ci_lower <- numeric(length = 112)  # 95%置信区间下限
ci_upper <- numeric(length = 112)  # 95%置信区间上限

# 自定义标准误函数[1,7](@ref)
stderr <- function(x) {
  sd(x, na.rm = TRUE) / sqrt(length(na.omit(x)))
}

for (v in 1:length(fi_fs_invest)) {
  # 提取当前acc_perm数据
  current_acc_perm <- fi_fs_invest[[v]][[2]]$acc_perm
  
  # 计算均值差[1](@ref)
  dec_acc[v] <- (acc_ins_bins - mean(current_acc_perm, na.rm = TRUE)) * 100
  
  # 计算标准误[7](@ref)
  ste_acc[v] <- stderr(current_acc_perm) * 100
  
  # 计算95%置信区间[2,5,7](@ref)
  n <- length(na.omit(current_acc_perm))
  t_critical <- qt(0.975, df = n - 1)  # 95%置信水平的t临界值
  ci_lower[v] <- dec_acc[v] - t_critical * ste_acc[v]
  ci_upper[v] <- dec_acc[v] + t_critical * ste_acc[v]
}

# 创建结果数据框
fi_all <- data.frame(
  name = names(fi_fs_invest),
  fi_value_percent = dec_acc,
  ste_value_percent = ste_acc,
  ci_lower = ci_lower,
  ci_upper = ci_upper
)

```

## Top features
### Feature selection
```{r fi-select}
threshold_value <- mean(fi_all$fi_value_percent) + sd(fi_all$fi_value_percent)

filtered_fi <- fi_all %>%
  filter(fi_value_percent > threshold_value) %>%  
  arrange(desc(fi_value_percent))
```

### figure
```{r figure_top14}
filtered_fi_sorted <- filtered_fi %>%
  arrange(desc(fi_value_percent)) %>%  # 按fi_value_percent降序排列
  mutate(name = factor(name, levels = name))  %>%
  mutate(category = ifelse(grepl("WNS", name), "WNS", 
                          ifelse(grepl("BNS", name), "BNS", "Other")))%>%
  mutate(border = ifelse(grepl("rDLPFC", name), "black",NA))


p<-ggplot(filtered_fi_sorted, aes(x = name, y = fi_value_percent)) +
  geom_errorbar(aes(ymin = ci_lower, ymax = ci_upper, color = category), 
                width = 0, size = 0.7) +
  geom_point(aes(fill = category, color = category), size = 3, shape = 22, stroke = 1.2, alpha = 1) +
  scale_fill_manual(values = c("WNS" = "#E69F00", "BNS" = "#56B4E9"),  # 浅色填充
                   name = "变量类型") +
  scale_color_manual(values = c("WNS" = "#E69F00", "BNS" = "#56B4E9"),  # 深色边框
                    name = "变量类型") +
  # 设置纵坐标范围从0开始
  #scale_y_continuous(limits = c(0, max(filtered_fi_sorted$ci_upper, na.rm = TRUE) * 1.1),
                     #expand = c(0, 0)) +
  # 设置坐标轴标签和标题
  #labs(title = "各变量均值与95%置信区间分布图",
  #     x = "变量名称",
  #     y = "fi_value_percent (%)",
  #     caption = "点表示均值，误差线表示95%置信区间") +
  # 调整主题样式
  theme_classic() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, size = 10),
        plot.title = element_text(hjust = 0.5, face = "bold"),
        legend.position = "bottom")  # 图例放在底部
print(p)
ggsave("top14_features.png", plot = p, width = 5, height = 5, dpi = 300)
```

```{r figure_top14}
# 读取数据
fi_fs_invest <- readRDS("fi_all_invest_WNS_BNS_5000.RData")
acc_ins_bins <- 0.9212

# 计算阈值并筛选top features
threshold_value <- mean(fi_all$fi_value_percent) + sd(fi_all$fi_value_percent)
filtered_fi <- fi_all %>%
  filter(fi_value_percent > threshold_value) %>%  
  arrange(desc(fi_value_percent))

# 提取原始数据并计算每个观测值的差异
filtered_data_list <- map(filtered_fi$name, function(var_name) {
  # 找到变量在原始列表中的位置
  v_index <- which(names(fi_fs_invest) == var_name)
  
  if (length(v_index) > 0) {
    # 计算每个观测值的差异 (acc_ins_bins - acc_perm) * 100
    diff_values <- (acc_ins_bins - fi_fs_invest[[v_index]][[2]]$acc_perm) * 100
    
    # 创建数据框
    data.frame(
      name = var_name,
      value = diff_values,
      category = ifelse(grepl("WNS", var_name), "WNS", 
                       ifelse(grepl("BNS", var_name), "BNS", "Other"))
    )
  }
})

# 合并所有数据
filtered_data_long <- bind_rows(filtered_data_list) %>%
  mutate(name = factor(name, levels = filtered_fi$name))  # 保持排序顺序

# 绘制箱线图
ggplot(filtered_data_long, aes(x = name, y = value)) +
  geom_boxplot(aes(fill = category), outlier.size = 0.5, alpha = 0.8, outlier.alpha = 0) +
  scale_fill_manual(values = c("WNS" = "#E69F00", "BNS" = "#56B4E9", "Other" = "#999999"),
                   name = "变量类型") +
  labs(title = paste("Top Features箱线图 (阈值:", round(threshold_value, 2), ")"),
       x = "变量名称", 
       y = "fi_value_percent (%)",
       caption = paste("展示了", nrow(filtered_fi), "个超过阈值的特征分布")) +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 10),
        plot.title = element_text(hjust = 0.5, face = "bold"),
        legend.position = "bottom")

# 显示筛选结果摘要
cat("阈值:", threshold_value, "\n")
cat("筛选出的特征数量:", nrow(filtered_fi), "\n")
cat("特征名称:", paste(filtered_fi$name, collapse = ", "), "\n")
```